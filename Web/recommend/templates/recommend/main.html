{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>AI ì£¼ì‹ íˆ¬ì ì‹œë®¬ë ˆì´í„°</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f5f7fb;
            color: #111827;
        }
        .page-wrap {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 24px 40px;
        }
        .page-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }
        .page-header-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, #2563eb, #22c55e);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 800;
        }
        .page-header-title {
            font-size: 22px;
            font-weight: 700;
        }
        .page-header-sub {
            font-size: 13px;
            color: #6b7280;
        }

        /* ì „ì²´ ë ˆì´ì•„ì›ƒ 6:4 */
        .layout-main {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 20px;
        }

        /* ì¹´ë“œ ê³µí†µ */
        .card {
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
            padding: 20px 22px;
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }
        .card-header-icon {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            background: #eff6ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .card-header-title {
            font-size: 16px;
            font-weight: 700;
        }
        .card-header-sub {
            font-size: 12px;
            color: #6b7280;
        }

        /* ì™¼ìª½ ì˜ì—­ (AI ì¶”ì²œ + LLM ì§ˆë¬¸) */
        .ai-card {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .ai-risk-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: #ecfdf3;
            color: #16a34a;
            font-size: 11px;
            font-weight: 600;
        }
        .ai-risk-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: #22c55e;
        }
        .ai-description {
            font-size: 13px;
            color: #4b5563;
            line-height: 1.5;
            margin-top: 4px;
        }
        .ai-usage-section {
            margin-top: 10px;
        }
        .ai-usage-label-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .ai-usage-bar-wrap {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
        }
        .ai-usage-bar-fill {
            width: 58%;
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, #2563eb, #22c55e);
        }

        .llm-question-section {
            margin-top: 16px;
        }
        .llm-question-label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .llm-input-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }
        .llm-input {
            flex: 1;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            padding: 10px 14px;
            font-size: 13px;
            outline: none;
            background: #f9fafb;
        }
        .llm-input:focus {
            border-color: #2563eb;
            background: #ffffff;
        }
        .llm-btn {
            border-radius: 999px;
            border: none;
            padding: 9px 16px;
            font-size: 13px;
            background: #111827;
            color: #ffffff;
            cursor: pointer;
        }
        .llm-btn:hover {
            background: #020617;
        }

        /* ì˜¤ë¥¸ìª½ ìƒë‹¨ - ì˜ˆì‚° ì¹´ë“œ */
        .budget-card {
            border: 2px solid #22c55e;
        }
        .budget-input-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        .budget-input {
            flex: 1;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            padding: 10px 14px;
            font-size: 13px;
            outline: none;
            background: #f9fafb;
        }
        .budget-input:focus {
            border-color: #22c55e;
            background: #ffffff;
        }
        .budget-btn {
            border-radius: 999px;
            border: none;
            padding: 10px 18px;
            font-size: 13px;
            background: #2563eb;
            color: #ffffff;
            cursor: pointer;
            white-space: nowrap;
        }
        .budget-btn:hover {
            background: #1d4ed8;
        }
        .budget-current {
            margin-top: 10px;
            font-size: 12px;
            color: #6b7280;
        }
        .budget-value {
            display: inline-block;
            margin-top: 4px;
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        /* ì˜¤ë¥¸ìª½ í•˜ë‹¨ - ì£¼ì‹ ê²€ìƒ‰ / ê²°ê³¼ */
        .stock-card {
            margin-top: 16px;
        }
        .stock-search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        .stock-search-input {
            flex: 1;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            padding: 10px 14px;
            font-size: 13px;
            outline: none;
            background: #f9fafb;
        }
        .stock-search-input:focus {
            border-color: #2563eb;
            background: #ffffff;
        }
        .stock-search-btn {
            border-radius: 999px;
            border: none;
            padding: 10px 18px;
            font-size: 13px;
            background: #111827;
            color: #ffffff;
            cursor: pointer;
            white-space: nowrap;
        }
        .stock-search-btn:hover {
            background: #020617;
        }

        .stock-result-card {
            margin-top: 16px;
            padding: 14px 16px;
            border-radius: 14px;
            background: linear-gradient(135deg, #eff6ff, #ecfdf3);
        }
        .stock-result-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
        }
        .stock-result-title {
            font-size: 15px;
            font-weight: 700;
        }
        .stock-result-code {
            font-size: 12px;
            color: #6b7280;
        }
        .stock-result-body {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .stock-price {
            font-size: 20px;
            font-weight: 700;
        }
        .stock-price .won {
            font-size: 13px;
            margin-left: 4px;
            color: #6b7280;
        }
        .stock-change {
            font-size: 13px;
            color: #16a34a;
        }
        .stock-error {
            margin-top: 16px;
            padding: 12px 14px;
            border-radius: 10px;
            background: #fef2f2;
            color: #b91c1c;
            font-size: 13px;
        }

        @media (max-width: 900px) {
            .layout-main {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="page-wrap">
    <!-- ìƒë‹¨ íƒ€ì´í‹€ -->
    <header class="page-header">
        <div class="page-header-icon">â‚©</div>
        <div>
            <div class="page-header-title">AI ì£¼ì‹ íˆ¬ì ì‹œë®¬ë ˆì´í„°</div>
            <div class="page-header-sub">ì¸ê³µì§€ëŠ¥ ê¸°ë°˜ ìŠ¤ë§ˆíŠ¸ íˆ¬ì ë¶„ì„ í”Œë«í¼</div>
        </div>
    </header>

    <!-- ë©”ì¸ 6:4 ë ˆì´ì•„ì›ƒ -->
    <div class="layout-main">
        <!-- ì™¼ìª½ : AI íˆ¬ì ì¶”ì²œ + LLM ì§ˆë¬¸ -->
        <div class="card ai-card">
            <div class="card-header">
                <div class="card-header-icon">âœ¨</div>
                <div>
                    <div class="card-header-title">AI íˆ¬ì ì¶”ì²œ</div>
                    <div class="card-header-sub">ì‹¤ì‹œê°„ LLM ë¶„ì„</div>
                </div>
            </div>

            <div>
                <div class="ai-risk-badge">
                    <span class="ai-risk-dot"></span>
                    ë¦¬ìŠ¤í¬ ìˆ˜ì¤€ <strong>ë‚®ìŒ</strong>
                </div>
                <p class="ai-description">
                    íˆ¬ì ì˜ˆì‚°ê³¼ ê´€ì‹¬ ìˆëŠ” ì£¼ì‹ì„ ê²€ìƒ‰í•˜ë©´, AIê°€ ì¢…ëª© íŠ¹ì„±ê³¼ ì‹œì„¸ ì •ë³´ë¥¼ ë¶„ì„í•´
                    íˆ¬ì ì „ëµì— ëŒ€í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
                </p>

                <div class="ai-usage-section">
                    <div class="ai-usage-label-row">
                        <span>AI ì‚¬ìš©ëŸ‰</span>
                        <span>58%</span>
                    </div>
                    <div class="ai-usage-bar-wrap">
                        <div class="ai-usage-bar-fill"></div>
                    </div>
                </div>

                <!-- LLM ì§ˆë¬¸ ì…ë ¥ -->
                <div class="llm-question-section">
                    <div class="llm-question-label">AIì—ê²Œ ì§ˆë¬¸í•˜ê¸°</div>
                    <form method="post" action="{% url 'main' %}">
                        {% csrf_token %}
                        <div class="llm-input-wrap">
                            <input
                                type="text"
                                name="llm_question"
                                class="llm-input"
                                placeholder="ì˜ˆ: í˜„ì¬ ì‚¼ì„±ì „ì íˆ¬ì ì „ëµì´ ê¶ê¸ˆí•´ìš”"
                            />
                            <button type="submit" class="llm-btn">
                                ì§ˆë¬¸í•˜ê¸°
                            </button>
                        </div>
                    </form>

                    <!-- LLM ë‹µë³€ ì˜ì—­ ì¶”ê°€ -->
                    {% if ai_answer %}
                    <div style="margin-top: 12px; padding: 12px 14px; border-radius: 12px;
                                background: #f9fafb; font-size: 13px; line-height: 1.7;
                                white-space: pre-wrap; color: #111827;">
                        {{ ai_answer }}
                    </div>
                    {% endif %}
                    <!-- /LLM ë‹µë³€ ì˜ì—­ -->
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ : ì˜ˆì‚° ì„¤ì • + ì£¼ì‹ ê²€ìƒ‰/ê²°ê³¼ -->
        <div>
            <!-- ì˜ˆì‚° ì¹´ë“œ -->
            <div class="card budget-card">
                <div class="card-header">
                    <div class="card-header-icon">ğŸ’°</div>
                    <div>
                        <div class="card-header-title">íˆ¬ì ì˜ˆì‚° ì„¤ì •</div>
                        <div class="card-header-sub">íˆ¬ì ê°€ëŠ¥í•œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”</div>
                    </div>
                </div>

                <form method="post" action="{% url 'main' %}">
                    {% csrf_token %}
                    <div class="budget-input-wrap">
                        <input
                            type="text"
                            name="budget_amount"
                            class="budget-input"
                            placeholder="ì˜ˆ: 1000000"
                            value="{{ budget|default:'' }}"
                        />
                        <button type="submit" name="budget_submit" class="budget-btn">
                            ì˜ˆì‚° ì„¤ì •
                        </button>
                    </div>

                    <div class="budget-current">
                        í˜„ì¬ ì„¤ì •ëœ ì˜ˆì‚°<br />
                        <span class="budget-value">
                            â‚©{{ budget|default:0 }}
                        </span>
                    </div>
                </form>
            </div>

            <!-- ì£¼ì‹ ê²€ìƒ‰ ì¹´ë“œ -->
            <div class="card stock-card">
                <div class="card-header">
                    <div class="card-header-icon">ğŸ”</div>
                    <div>
                        <div class="card-header-title">ì£¼ì‹ ê²€ìƒ‰</div>
                        <div class="card-header-sub">ì¢…ëª© ì½”ë“œ ë˜ëŠ” ì´ë¦„ì„ ê²€ìƒ‰í•´ ë³´ì„¸ìš”</div>
                    </div>
                </div>

                <form method="post" action="{% url 'main' %}">
                    {% csrf_token %}
                    <div class="stock-search-box">
                        <input
                            type="text"
                            name="stock_keyword"
                            class="stock-search-input"
                            placeholder="ì˜ˆ: 005930"
                        />
                        <button type="submit" name="stock_search" class="stock-search-btn">
                            ê²€ìƒ‰
                        </button>
                    </div>
                </form>

                <!-- ê²€ìƒ‰ ê²°ê³¼ / ì—ëŸ¬ ì˜ì—­ -->
                {% if api_error %}
                    <div class="stock-error">
                        {{ api_message }}
                    </div>
                {% elif stock_name %}
                    <div class="stock-result-card">
                        <div class="stock-result-header">
                            <span class="stock-result-title">{{ stock_name }}</span>
                            <span class="stock-result-code">{{ stock_code }}</span>
                        </div>

                        <div class="stock-result-body">
                            <div class="stock-price">
                                {{ price }}<span class="won">ì›</span>
                            </div>
                            <div class="stock-change">
                                {{ change }}ì› ({{ change_rate }}%)
                            </div>
                        </div>

                        {% if open_price %}
                            <div style="margin-top: 10px; font-size: 12px; color: #374151;">
                                ì‹œê°€ {{ open_price }} / ê³ ê°€ {{ high_price }} /
                                ì €ê°€ {{ low_price }} / ê±°ë˜ëŸ‰ {{ volume }}
                            </div>
                        {% endif %}

                        <!-- ì°¨íŠ¸ -->
                        <div style="margin-top: 12px; background: rgba(255,255,255,0.7); border-radius: 10px; padding: 8px; height: 220px;">
                            <canvas id="stockChart"></canvas>
                        </div>
                        <div style="margin-top: 4px; font-size: 11px; color: #6b7280; text-align: right;">
                            xì¶•: ë‚ ì§œ Â· yì¶•: ì¢…ê°€(ì›)
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# ===== ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ (ë°ì´í„° ìˆì„ ë•Œë§Œ) ===== #}
{% if stock_name and chart_labels and chart_prices %}
<script>
    const chartLabels = {{ chart_labels|safe }};
    const chartPrices = {{ chart_prices|safe }};

    const ctx = document.getElementById("stockChart").getContext("2d");

    new Chart(ctx, {
        type: "line",
        data: {
            labels: chartLabels,
            datasets: [{
                label: "ì¢…ê°€(ì›)",
                data: chartPrices,
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 0,
                fill: true,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: (items) => "ë‚ ì§œ: " + items[0].label,
                        label: (item) =>
                            "ê°€ê²©: " + item.parsed.y.toLocaleString() + "ì›",
                    }
                }
            },
            layout: {
                padding: { top: 6, right: 8, bottom: 4, left: 8 },
            },
            scales: {
                x: {
                    display: true,
                    grid: { display: true },
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 5,
                        callback: (value, index) => {
                            const label = chartLabels[index] || "";
                            // YYYY-MM-DD -> MM-DDë§Œ í‘œì‹œ
                            return label.length >= 5 ? label.slice(5) : label;
                        },
                    },
                    title: {
                        display: true,
                        text: "ë‚ ì§œ",
                    }
                },
                y: {
                    display: true,
                    grid: { display: true },
                    ticks: {
                        display: true,
                        maxTicksLimit: 5,
                        callback: (value) => value.toLocaleString() + "ì›",
                    },
                    title: {
                        display: false,  // ì œëª©ì€ ìˆ¨ê¹€
                    },
                    beginAtZero: false,
                }
            }
        }
    });
</script>
{% endif %}
</body>
</html>
